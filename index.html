<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Catraca RFID - Simulação de Clonagem</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ESTILO GERAL */
        :root {
            --primary-color: #2049ff;
            --primary-light: #4d6eff;
            --primary-dark: #1a0d72;
            --accent-color: #20ff49;
            --text-light: #f0f0f0;
            --text-dark: #121212;
            --bg-dark: #0a0a0f;
            --bg-card: rgba(18, 18, 24, 0.7);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --success: #20ff49;
            --warning: #ffcc00;
            --danger: #ff2040;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Background com grade animada */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(10, 10, 15, 0.95), rgba(10, 10, 15, 0.95)),
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(32, 73, 255, 0.03) 50px, rgba(32, 73, 255, 0.03) 51px),
                repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(32, 73, 255, 0.03) 50px, rgba(32, 73, 255, 0.03) 51px);
            z-index: -2;
        }

        /* Efeito de partículas luminosas */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: var(--primary-color);
            border-radius: 50%;
            opacity: 0;
            animation: float 15s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.3;
            }
            90% {
                opacity: 0.1;
            }
            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: var(--transition);
        }

        header:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(-5px);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 600;
            background: linear-gradient(to right, var(--text-light), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            opacity: 0.8;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1100px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        }

        .card h2 {
            color: var(--text-light);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: var(--primary-color);
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--glass-border);
        }

        .user-item.active {
            background: rgba(32, 73, 255, 0.15);
            border-color: var(--primary-color);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-details {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .user-balance {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-light);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px;
        }

        button {
            padding: 12px 18px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid var(--glass-border);
        }

        button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--primary-light);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: var(--danger);
            border-color: var(--danger);
        }

        .btn-danger:hover {
            background: #ff4060;
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #40ff60;
        }

        .btn-warning {
            background: var(--warning);
            border-color: var(--warning);
            color: var(--primary-dark);
        }

        .btn-warning:hover {
            background: #ffd740;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
            opacity: 0.9;
        }

        input, select {
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            color: var(--text-light);
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.12);
        }

        .simulation-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .rfid-reader {
            background: var(--primary-color);
            color: white;
            padding: 24px;
            border-radius: var(--radius-lg);
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--primary-light);
        }

        .rfid-reader:hover {
            background: var(--primary-light);
            transform: scale(1.02);
        }

        .rfid-reader.scanning {
            animation: pulse 1.5s infinite;
        }

        .clone-simulation {
            background: rgba(255, 204, 0, 0.2);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 24px;
            border-radius: var(--radius-lg);
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .clone-simulation:hover {
            background: rgba(255, 204, 0, 0.3);
            transform: scale(1.02);
        }

        .clone-simulation.scanning {
            animation: pulse-warning 1.5s infinite;
        }

        @keyframes pulse {
            0% { background-color: var(--primary-color); }
            50% { background-color: var(--primary-light); }
            100% { background-color: var(--primary-color); }
        }

        @keyframes pulse-warning {
            0% { background-color: rgba(255, 204, 0, 0.2); }
            50% { background-color: rgba(255, 204, 0, 0.4); }
            100% { background-color: rgba(255, 204, 0, 0.2); }
        }

        .logs {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            padding: 16px;
            font-family: monospace;
            font-size: 0.9rem;
            border: 1px solid var(--glass-border);
        }

        .log-entry {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-time {
            color: rgba(255, 255, 255, 0.6);
            font-weight: bold;
        }

        .log-success {
            color: var(--success);
        }

        .log-warning {
            color: var(--warning);
        }

        .log-error {
            color: var(--danger);
        }

        .map-container {
            height: 400px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .pin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .pin-modal.active {
            display: flex;
        }

        .pin-content {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .pinpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .pinpad-btn {
            padding: 16px;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
        }

        .pinpad-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .pin-display {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--glass-border);
            transition: var(--transition);
        }

        .pin-dot.filled {
            background-color: var(--primary-color);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background-color: var(--success);
        }

        .status-blocked {
            background-color: var(--danger);
        }

        .status-warning {
            background-color: var(--warning);
        }

        .alert {
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            border: 1px solid;
        }

        .alert-warning {
            background: rgba(255, 204, 0, 0.1);
            border-color: var(--warning);
            color: var(--warning);
        }

        .alert-danger {
            background: rgba(255, 32, 64, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        .alert-success {
            background: rgba(32, 255, 73, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .json-editor {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 16px;
            font-family: monospace;
            font-size: 0.85rem;
            height: 200px;
            width: 100%;
            resize: vertical;
            color: var(--text-light);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }

        .clone-info {
            background: rgba(255, 204, 0, 0.1);
            border: 1px solid var(--warning);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 20px;
            color: var(--warning);
        }

        .distance-info {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
        }

        .points-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .point-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
            color: var(--text-light);
        }

        .point-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--primary-color);
        }

        .point-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-light);
        }

        .time-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 12px;
        }

        .time-input {
            width: 80px;
            text-align: center;
        }

        .time-suggestion {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 8px;
        }

        .time-suggestion button {
            padding: 6px 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .distance-display {
            background: rgba(255, 255, 255, 0.08);
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            margin-top: 8px;
            border: 1px solid var(--glass-border);
        }

        .usage-history {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 12px;
            font-size: 0.85rem;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .debug-info {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 12px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .clone-badge {
            background: var(--warning);
            color: var(--primary-dark);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .simulation-mode {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 16px;
            text-align: center;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .mode-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-light);
        }

        .mode-btn.clone-mode {
            background: rgba(255, 204, 0, 0.1);
            border-color: var(--warning);
        }

        .mode-btn.clone-mode.active {
            background: var(--warning);
            color: var(--primary-dark);
            border-color: #ffd740;
        }

        .icon-lg {
            font-size: 1.5rem;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
    </style>
</head>
<body>
    <!-- Efeito de partículas -->
    <div class="particles" id="particles"></div>

    <div class="container">
        <header>
            <h1><i class="fas fa-id-card-alt"></i> Sistema de Catraca RFID</h1>
            <p class="subtitle">Simulação de segurança e detecção de clonagem</p>
        </header>

        <div class="dashboard">
            <!-- Painel de Usuários -->
            <div class="card">
                <h2><i class="fas fa-users"></i> Usuários do Sistema</h2>
                <div class="user-list" id="userList">
                    <!-- Usuários serão carregados aqui -->
                </div>
            </div>

            <!-- Painel de Controle -->
            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> Controles de Simulação</h2>
                <div class="controls">
                    <div class="input-group">
                        <label for="selectedUser"><i class="fas fa-user-check"></i> Usuário/Cartão Selecionado:</label>
                        <select id="selectedUser">
                            <option value="">Selecione um usuário</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <button id="btnCloneCard" class="btn-secondary"><i class="fas fa-copy"></i> Criar Clone Permanente</button>
                        <button id="btnResetCard" class="btn-secondary"><i class="fas fa-redo"></i> Resetar Histórico</button>
                        <button id="btnAddBalance" class="btn-success"><i class="fas fa-plus-circle"></i> Adicionar Saldo</button>
                    </div>

                    <div class="simulation-mode">
                        <button class="mode-btn active" data-mode="normal">
                            <i class="fas fa-id-card icon-lg"></i>
                            Modo Normal
                        </button>
                        <button class="mode-btn clone-mode" data-mode="clone">
                            <i class="fas fa-clone icon-lg"></i>
                            Modo Clonagem
                        </button>
                    </div>

                    <div class="input-group">
                        <label><i class="fas fa-map-marker-alt"></i> Selecionar Ponto de Parada:</label>
                        <div class="points-grid" id="pointsGrid">
                            <!-- Pontos serão carregados aqui -->
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="timeBetweenUses"><i class="fas fa-clock"></i> Tempo desde último uso (minutos):</label>
                        <div class="time-controls">
                            <input type="number" id="timeBetweenUses" class="time-input" min="0" max="120" value="5">
                            <button id="btnSetTime" class="btn-primary"><i class="fas fa-check"></i> Definir Tempo</button>
                        </div>
                        <div class="time-suggestion" id="timeSuggestion">
                            <!-- Sugestão de tempo será exibida aqui -->
                        </div>
                        <div class="distance-display" id="distanceDisplay" style="display: none;">
                            <!-- Distância será exibida aqui -->
                        </div>
                    </div>

                    <div class="usage-history" id="usageHistory" style="display: none;">
                        <strong><i class="fas fa-history"></i> Histórico de Uso:</strong>
                        <div id="historyList">
                            <!-- Histórico será exibido aqui -->
                        </div>
                    </div>

                    <div class="debug-info" id="debugInfo" style="display: none;">
                        <strong><i class="fas fa-bug"></i> Informações de Debug:</strong>
                        <div id="debugDetails"></div>
                    </div>

                    <div class="clone-info" id="cloneInfo" style="display: none;">
                        <strong><i class="fas fa-exclamation-triangle"></i> Modo Clonagem Ativo:</strong> 
                        <span id="cloneDetails">Simulando uso com cartão clonado (mesmo UID)</span>
                    </div>

                    <div class="simulation-area">
                        <div class="rfid-reader" id="rfidReader">
                            <i class="fas fa-id-card icon-lg"></i>
                            USO NORMAL - APROXIME O CARTÃO
                        </div>
                        <div class="clone-simulation" id="cloneSimulation" style="display: none;">
                            <i class="fas fa-clone icon-lg"></i>
                            SIMULAR USO COM CARTAÃO CLONADO
                        </div>
                    </div>

                    <div class="alert alert-warning" id="securityAlert" style="display: none;">
                        <strong><i class="fas fa-shield-alt"></i> Alerta de Segurança:</strong> Uso suspeito detectado! Verificação de PIN necessária.
                    </div>

                    <div class="logs" id="accessLogs">
                        <div class="log-entry">
                            <span class="log-time">[10:15:32]</span> 
                            <span class="log-success">Sistema inicializado. Aguardando leituras...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Painel de Mapa -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2><i class="fas fa-map"></i> Mapa de Pontos de Parada</h2>
                <div class="map-container" id="map"></div>
            </div>

            <!-- Painel de Status e JSON -->
            <div class="card">
                <div class="tabs">
                    <div class="tab active" data-tab="status"><i class="fas fa-info-circle"></i> Status do Sistema</div>
                    <div class="tab" data-tab="json"><i class="fas fa-code"></i> Editor JSON</div>
                </div>
                
                <div id="statusTab">
                    <div id="systemStatus">
                        <p><span class="status-indicator status-active"></span> Sistema Operacional</p>
                        <p><span class="status-indicator status-active"></span> Detecção de Uso Suspeito Ativa</p>
                        <p><span class="status-indicator status-active"></span> Simulação de Clonagem Disponível</p>
                    </div>
                    <div class="control-group" style="margin-top: 20px;">
                        <button id="btnRefreshData" class="btn-primary"><i class="fas fa-sync"></i> Atualizar Dados</button>
                        <button id="btnClearLogs" class="btn-secondary"><i class="fas fa-trash"></i> Limpar Logs</button>
                        <button id="btnExportJSON" class="btn-success"><i class="fas fa-download"></i> Exportar JSON</button>
                    </div>
                </div>
                
                <div id="jsonTab" style="display: none;">
                    <div class="input-group">
                        <label for="jsonData"><i class="fas fa-file-code"></i> Dados do Sistema (JSON):</label>
                        <textarea id="jsonData" class="json-editor"></textarea>
                    </div>
                    <div class="control-group">
                        <button id="btnLoadJSON" class="btn-primary"><i class="fas fa-upload"></i> Carregar JSON</button>
                        <button id="btnResetJSON" class="btn-secondary"><i class="fas fa-undo"></i> Resetar Dados</button>
                    </div>
                </div>
            </div>

            <!-- Painel de Estatísticas -->
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Estatísticas de Uso</h2>
                <div id="usageStats">
                    <p><i class="fas fa-users"></i> Total de Usuários: <strong id="totalUsers">0</strong></p>
                    <p><i class="fas fa-bus"></i> Viagens Hoje: <strong id="tripsToday">0</strong></p>
                    <p><i class="fas fa-shield-alt"></i> Alertas de Segurança: <strong id="securityAlerts">0</strong></p>
                    <p><i class="fas fa-ban"></i> Cartões Bloqueados: <strong id="blockedCards">0</strong></p>
                    <p><i class="fas fa-clone"></i> Simulações de Clonagem: <strong id="cloneSimulations">0</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para entrada de PIN -->
    <div class="pin-modal" id="pinModal">
        <div class="pin-content">
            <h2><i class="fas fa-lock"></i> Verificação de Segurança</h2>
            <p id="pinMessage">Uso suspeito detectado. Por favor, insira seu PIN de 4 dígitos:</p>
            
            <div class="pin-display">
                <div class="pin-dot" id="pinDot1"></div>
                <div class="pin-dot" id="pinDot2"></div>
                <div class="pin-dot" id="pinDot3"></div>
                <div class="pin-dot" id="pinDot4"></div>
            </div>
            
            <div class="pinpad">
                <button class="pinpad-btn" data-digit="1">1</button>
                <button class="pinpad-btn" data-digit="2">2</button>
                <button class="pinpad-btn" data-digit="3">3</button>
                <button class="pinpad-btn" data-digit="4">4</button>
                <button class="pinpad-btn" data-digit="5">5</button>
                <button class="pinpad-btn" data-digit="6">6</button>
                <button class="pinpad-btn" data-digit="7">7</button>
                <button class="pinpad-btn" data-digit="8">8</button>
                <button class="pinpad-btn" data-digit="9">9</button>
                <button class="pinpad-btn" id="btnClearPin">C</button>
                <button class="pinpad-btn" data-digit="0">0</button>
                <button class="pinpad-btn" id="btnBackspace"><i class="fas fa-backspace"></i></button>
            </div>
            
            <div class="control-group">
                <button id="btnSubmitPin" class="btn-primary"><i class="fas fa-check"></i> Verificar</button>
                <button id="btnCancelPin" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
            </div>
            <p id="pinError" style="color: var(--danger); margin-top: 10px; display: none;"><i class="fas fa-exclamation-circle"></i> PIN incorreto. Tente novamente.</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Dados iniciais em JSON
        const initialData = {
            "users": [
                { 
                    "id": 1, 
                    "name": "João Silva", 
                    "uid": "A1B2C3D4", 
                    "pin": "1234", 
                    "balance": 25.50, 
                    "status": "active", 
                    "lastUse": null, 
                    "lastLocation": null,
                    "cardType": "normal",
                    "usageHistory": []
                },
                { 
                    "id": 2, 
                    "name": "Maria Oliveira", 
                    "uid": "E5F6G7H8", 
                    "pin": "5678", 
                    "balance": 12.75, 
                    "status": "active", 
                    "lastUse": null, 
                    "lastLocation": null,
                    "cardType": "student",
                    "usageHistory": []
                },
                { 
                    "id": 3, 
                    "name": "Carlos Santos", 
                    "uid": "I9J0K1L2", 
                    "pin": "9012", 
                    "balance": 8.20, 
                    "status": "active", 
                    "lastUse": null, 
                    "lastLocation": null,
                    "cardType": "normal",
                    "usageHistory": []
                },
                { 
                    "id": 4, 
                    "name": "Ana Costa", 
                    "uid": "M3N4O5P6", 
                    "pin": "3456", 
                    "balance": 32.10, 
                    "status": "active", 
                    "lastUse": null, 
                    "lastLocation": null,
                    "cardType": "elderly",
                    "usageHistory": []
                },
                { 
                    "id": 5, 
                    "name": "Pedro Almeida", 
                    "uid": "Q7R8S9T0", 
                    "pin": "7890", 
                    "balance": 5.50, 
                    "status": "blocked", 
                    "lastUse": null, 
                    "lastLocation": null,
                    "cardType": "normal",
                    "usageHistory": []
                }
            ],
            "locations": [
                { "id": "ponto_centro", "name": "Centro", "coords": [-23.5505, -46.6333], "type": "ponto" },
                { "id": "ponto_sul", "name": "Ponto Sul", "coords": [-23.5600, -46.6400], "type": "ponto" },
                { "id": "ponto_norte", "name": "Ponto Norte", "coords": [-23.5400, -46.6200], "type": "ponto" },
                { "id": "ponto_leste", "name": "Ponto Leste", "coords": [-23.5450, -46.6100], "type": "ponto" },
                { "id": "ponto_oeste", "name": "Ponto Oeste", "coords": [-23.5550, -46.6500], "type": "ponto" },
                { "id": "estacao_central", "name": "Estação Central", "coords": [-23.5489, -46.6388], "type": "estacao" },
                { "id": "estacao_sul", "name": "Estação Sul", "coords": [-23.5650, -46.6450], "type": "estacao" },
                { "id": "terminal_aeroporto", "name": "Terminal Aeroporto", "coords": [-23.4356, -46.4731], "type": "terminal" },
                { "id": "shopping_center", "name": "Shopping Center", "coords": [-23.5350, -46.6550], "type": "ponto" },
                { "id": "universidade", "name": "Universidade", "coords": [-23.5580, -46.7300], "type": "ponto" }
            ],
            "settings": {
                "fare": 4.50,
                "studentFare": 2.25,
                "elderlyFare": 0.00,
                "suspiciousTimeThreshold": 10,
                "maxDailyTrips": 10,
                "apiKey": "rfid-transport-system-2024"
            },
            "clonedCards": [],
            "accessLogs": [],
            "systemStats": {
                "totalTrips": 0,
                "totalRevenue": 0,
                "securityAlerts": 0,
                "cloneSimulations": 0,
                "lastUpdate": new Date().toISOString()
            }
        };

        // Variáveis globais
        let systemData = JSON.parse(JSON.stringify(initialData));
        let selectedUser = null;
        let clonedCard = null;
        let accessLogs = [];
        let map;
        let markers = [];
        let suspiciousUsers = ["Suspeito 1", "Suspeito 2", "Suspeito 3", "Suspeito 4", "Suspeito 5"];
        let selectedPoint = null;
        let currentPin = "";
        let manualTimeBetweenUses = 5;
        let simulationMode = "normal"; // "normal" ou "clone"

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeMap();
            setupEventListeners();
            updateJSONEditor();
        });

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 25;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                // Tamanho aleatório
                const size = Math.random() * 4 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                // Posição inicial aleatória
                particle.style.left = `${Math.random() * 100}vw`;
                
                // Atraso aleatório na animação
                particle.style.animationDelay = `${Math.random() * 15}s`;
                
                // Opacidade aleatória
                particle.style.opacity = Math.random() * 0.5 + 0.1;
                
                particlesContainer.appendChild(particle);
            }
        }

        function initializeApp() {
            renderUserList();
            updateUserSelect();
            updatePointsGrid();
            updateStatistics();
            updateCloneInfo();
            updateUsageHistory();
            updateSimulationMode();
        }

        function initializeMap() {
            map = L.map('map').setView([-23.5505, -46.6333], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            systemData.locations.forEach(location => {
                let iconColor = 'blue';
                if (location.type === 'estacao') iconColor = 'red';
                if (location.type === 'terminal') iconColor = 'orange';
                
                const marker = L.marker(location.coords, {
                    icon: L.divIcon({
                        className: 'custom-icon',
                        html: `<div style="background-color: ${iconColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                }).addTo(map)
                    .bindPopup(`<b>${location.name}</b><br>${location.type === 'ponto' ? 'Ponto de Ônibus' : location.type === 'estacao' ? 'Estação' : 'Terminal'}`);
                markers.push(marker);
            });
        }

        function setupEventListeners() {
            // Leitores RFID
            document.getElementById('rfidReader').addEventListener('click', simulateRFIDScan);
            document.getElementById('cloneSimulation').addEventListener('click', simulateCloneUsage);

            // Botões de controle
            document.getElementById('btnCloneCard').addEventListener('click', cloneCard);
            document.getElementById('btnResetCard').addEventListener('click', resetCard);
            document.getElementById('btnAddBalance').addEventListener('click', addBalance);
            document.getElementById('btnRefreshData').addEventListener('click', refreshData);
            document.getElementById('btnClearLogs').addEventListener('click', clearLogs);
            document.getElementById('btnExportJSON').addEventListener('click', exportJSON);
            document.getElementById('btnSetTime').addEventListener('click', setManualTime);

            // Modal de PIN
            document.getElementById('btnSubmitPin').addEventListener('click', verifyPin);
            document.getElementById('btnCancelPin').addEventListener('click', cancelPin);

            // Modos de simulação
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    simulationMode = this.dataset.mode;
                    updateSimulationMode();
                });
            });

            // PIN Pad
            document.querySelectorAll('.pinpad-btn[data-digit]').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (currentPin.length < 4) {
                        currentPin += this.dataset.digit;
                        updatePinDisplay();
                    }
                });
            });

            document.getElementById('btnClearPin').addEventListener('click', function() {
                currentPin = "";
                updatePinDisplay();
            });

            document.getElementById('btnBackspace').addEventListener('click', function() {
                currentPin = currentPin.slice(0, -1);
                updatePinDisplay();
            });

            // JSON Editor
            document.getElementById('btnLoadJSON').addEventListener('click', loadJSON);
            document.getElementById('btnResetJSON').addEventListener('click', resetJSON);

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.getElementById('statusTab').style.display = 'none';
                    document.getElementById('jsonTab').style.display = 'none';
                    
                    document.getElementById(this.dataset.tab + 'Tab').style.display = 'block';
                });
            });

            // Seleção de usuário
            document.getElementById('selectedUser').addEventListener('change', function() {
                const userId = this.value;
                
                if (userId && userId.startsWith('clone_')) {
                    const cloneId = userId.split('_')[1];
                    clonedCard = systemData.clonedCards.find(c => c.id == cloneId);
                    selectedUser = null;
                } else {
                    selectedUser = systemData.users.find(user => user.id == userId) || null;
                    clonedCard = null;
                }
                
                if (selectedUser || clonedCard) {
                    highlightSelectedUser(userId);
                }
                
                updateCloneInfo();
                updateUsageHistory();
                updateDebugInfo();
            });
        }

        function updateSimulationMode() {
            const normalBtn = document.querySelector('.mode-btn[data-mode="normal"]');
            const cloneBtn = document.querySelector('.mode-btn[data-mode="clone"]');
            const rfidReader = document.getElementById('rfidReader');
            const cloneSimulation = document.getElementById('cloneSimulation');
            const cloneInfo = document.getElementById('cloneInfo');

            // Atualiza botões
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if (simulationMode === 'normal') {
                normalBtn.classList.add('active');
            } else {
                cloneBtn.classList.add('active');
            }

            // Atualiza visibilidade dos leitores
            if (simulationMode === 'normal') {
                rfidReader.style.display = 'flex';
                cloneSimulation.style.display = 'none';
                cloneInfo.style.display = 'none';
            } else {
                rfidReader.style.display = 'none';
                cloneSimulation.style.display = 'flex';
                cloneInfo.style.display = 'block';
            }
        }

        function updateDebugInfo() {
            const userToCheck = selectedUser || clonedCard;
            const debugInfo = document.getElementById('debugInfo');
            const debugDetails = document.getElementById('debugDetails');
            
            if (userToCheck) {
                debugInfo.style.display = 'block';
                debugDetails.innerHTML = `
                    <div>Usuário: ${userToCheck.name || userToCheck.userName}</div>
                    <div>Modo: ${simulationMode === 'clone' ? 'CLONAGEM' : 'NORMAL'}</div>
                    <div>Último uso: ${userToCheck.lastUse ? new Date(userToCheck.lastUse).toLocaleTimeString() : 'Nenhum'}</div>
                    <div>Última localização: ${userToCheck.lastLocation || 'Nenhuma'}</div>
                    <div>Tempo definido: ${manualTimeBetweenUses} minutos</div>
                `;
            } else {
                debugInfo.style.display = 'none';
            }
        }

        function updateUsageHistory() {
            const userToCheck = selectedUser || clonedCard;
            const usageHistory = document.getElementById('usageHistory');
            const historyList = document.getElementById('historyList');
            
            if (userToCheck && userToCheck.usageHistory && userToCheck.usageHistory.length > 0) {
                usageHistory.style.display = 'block';
                historyList.innerHTML = '';
                
                const recentHistory = userToCheck.usageHistory.slice(-5).reverse();
                
                recentHistory.forEach(usage => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <span>${usage.location}</span>
                        <span>${new Date(usage.timestamp).toLocaleTimeString()}</span>
                    `;
                    historyList.appendChild(historyItem);
                });
            } else {
                usageHistory.style.display = 'none';
            }
        }

        function updatePinDisplay() {
            const dots = [
                document.getElementById('pinDot1'),
                document.getElementById('pinDot2'),
                document.getElementById('pinDot3'),
                document.getElementById('pinDot4')
            ];
            
            dots.forEach((dot, index) => {
                if (index < currentPin.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            });
        }

        function setManualTime() {
            const timeInput = document.getElementById('timeBetweenUses');
            const timeValue = parseInt(timeInput.value);
            
            if (isNaN(timeValue) || timeValue < 0) {
                addLog('Por favor, insira um valor de tempo válido.', 'error');
                return;
            }
            
            manualTimeBetweenUses = timeValue;
            addLog(`Tempo desde último uso definido para ${manualTimeBetweenUses} minutos.`, 'success');
            updateDebugInfo();
        }

        function calculateAndDisplayDistance() {
            const userToCheck = selectedUser || clonedCard;
            if (!userToCheck || !userToCheck.lastLocation || !selectedPoint) return;
            
            const lastLocationData = systemData.locations.find(loc => loc.id === userToCheck.lastLocation);
            const currentLocationData = systemData.locations.find(loc => loc.id === selectedPoint);
            
            if (lastLocationData && currentLocationData) {
                const distance = calculateDistance(
                    lastLocationData.coords[0], lastLocationData.coords[1],
                    currentLocationData.coords[0], currentLocationData.coords[1]
                );
                
                const distanceDisplay = document.getElementById('distanceDisplay');
                distanceDisplay.innerHTML = `
                    <strong>Distância do último uso:</strong> ${distance.toFixed(2)} km<br>
                    <strong>Tempo mínimo realista:</strong> ${calculateRealisticTime(distance)} minutos
                `;
                distanceDisplay.style.display = 'block';
                
                updateTimeSuggestion(distance);
            }
        }

        function calculateRealisticTime(distance) {
            const urbanSpeed = 25;
            const minTime = Math.max(Math.ceil((distance / urbanSpeed) * 60), 10);
            return minTime;
        }

        function updateTimeSuggestion(distance) {
            const realisticTime = calculateRealisticTime(distance);
            const timeSuggestion = document.getElementById('timeSuggestion');
            
            let suggestionText = '';
            if (manualTimeBetweenUses < realisticTime) {
                suggestionText = `⚠️ TEMPO SUSPEITO! Para ${distance.toFixed(2)}km, o tempo mínimo realista é ${realisticTime} minutos. `;
                suggestionText += `<button class="btn-primary" onclick="setRealisticTime(${realisticTime})">Usar ${realisticTime} min</button>`;
            } else {
                suggestionText = `✅ Tempo adequado para a distância de ${distance.toFixed(2)}km.`;
            }
            
            timeSuggestion.innerHTML = suggestionText;
        }

        function setRealisticTime(time) {
            document.getElementById('timeBetweenUses').value = time;
            setManualTime();
        }

        function simulateRFIDScan() {
            if (simulationMode !== 'normal') return;
            
            const userToScan = selectedUser || clonedCard;
            
            if (!userToScan) {
                addLog('Selecione um usuário antes de simular a leitura.', 'error');
                return;
            }
            
            if (!selectedPoint) {
                addLog('Selecione um ponto de parada antes de simular a leitura.', 'error');
                return;
            }

            const reader = document.getElementById('rfidReader');
            reader.classList.add('scanning');
            
            setTimeout(() => {
                reader.classList.remove('scanning');
                processRFIDAccess(userToScan, false);
            }, 1500);
        }

        function simulateCloneUsage() {
            if (simulationMode !== 'clone') return;
            
            const userToScan = selectedUser || clonedCard;
            
            if (!userToScan) {
                addLog('Selecione um usuário antes de simular uso com clone.', 'error');
                return;
            }
            
            if (!selectedPoint) {
                addLog('Selecione um ponto de parada antes de simular uso com clone.', 'error');
                return;
            }

            const cloneReader = document.getElementById('cloneSimulation');
            cloneReader.classList.add('scanning');
            
            setTimeout(() => {
                cloneReader.classList.remove('scanning');
                processRFIDAccess(userToScan, true);
            }, 1500);
        }

        function processRFIDAccess(user, isCloneSimulation) {
            const location = selectedPoint;
            const locationData = systemData.locations.find(loc => loc.id === location);
            const locationName = locationData ? locationData.name : "Local Desconhecido";
            
            if (user.status === 'blocked') {
                addLog(`Acesso NEGADO para ${user.name || user.userName}. Cartão bloqueado.`, 'error');
                return;
            }

            const fare = getFareForUser(user);
            if (user.balance < fare) {
                addLog(`Acesso NEGADO para ${user.name || user.userName}. Saldo insuficiente.`, 'error');
                return;
            }

            const suspicious = checkSuspiciousUsage(user, location);
            
            if (suspicious) {
                const simulationType = isCloneSimulation ? ' (SIMULAÇÃO CLONE)' : '';
                addLog(`🚨 USO SUSPEITO DETECTADO para ${user.name || user.userName}${simulationType}! Verificação de PIN necessária.`, 'warning');
                document.getElementById('securityAlert').style.display = 'block';
                showPinModal(user, location, isCloneSimulation);
            } else {
                grantAccess(user, location, locationName, isCloneSimulation);
            }
        }

        function getFareForUser(user) {
            if (user.cardType === 'student') {
                return systemData.settings.studentFare;
            } else if (user.cardType === 'elderly') {
                return systemData.settings.elderlyFare;
            } else {
                return systemData.settings.fare;
            }
        }

        function checkSuspiciousUsage(user, currentLocation) {
            if (!user.lastUse || !user.lastLocation) {
                addLog(`Primeiro uso registrado para ${user.name || user.userName}.`, 'success');
                return false;
            }
            
            if (user.lastLocation === currentLocation) {
                return false;
            }
            
            const lastLocationData = systemData.locations.find(loc => loc.id === user.lastLocation);
            const currentLocationData = systemData.locations.find(loc => loc.id === currentLocation);
            
            if (!lastLocationData || !currentLocationData) {
                return false;
            }
            
            const distance = calculateDistance(
                lastLocationData.coords[0], lastLocationData.coords[1],
                currentLocationData.coords[0], currentLocationData.coords[1]
            );
            
            const realisticTime = calculateRealisticTime(distance);
            
            addLog(`DEBUG: Distância: ${distance.toFixed(2)}km, Tempo definido: ${manualTimeBetweenUses}min, Tempo realista: ${realisticTime}min`, 'warning');
            
            if (manualTimeBetweenUses < realisticTime) {
                addLog(`🚨 ALERTA: Viagem de ${distance.toFixed(2)}km impossível em ${manualTimeBetweenUses} minutos!`, 'warning');
                return true;
            }
            
            return false;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance;
        }

        function grantAccess(user, location, locationName, isCloneSimulation) {
            const fare = getFareForUser(user);
            user.balance -= fare;
            
            const now = new Date();
            user.lastUse = now.toISOString();
            user.lastLocation = location;
            
            if (!user.usageHistory) user.usageHistory = [];
            user.usageHistory.push({
                location: locationName,
                timestamp: now.toISOString(),
                fare: fare,
                isClone: isCloneSimulation
            });
            
            if (user.usageHistory.length > 10) {
                user.usageHistory = user.usageHistory.slice(-10);
            }
            
            const simulationType = isCloneSimulation ? ' (SIMULAÇÃO CLONE)' : '';
            addLog(`✅ Acesso PERMITIDO para ${user.name || user.userName}${simulationType} em ${locationName}. Tarifa: R$ ${fare.toFixed(2)} | Saldo: R$ ${user.balance.toFixed(2)}`, 'success');
            
            if (isCloneSimulation) {
                systemData.systemStats.cloneSimulations++;
                updateStatistics();
            }
            
            renderUserList();
            updateUserSelect();
            updateStatistics();
            updateCloneInfo();
            updateUsageHistory();
            updateDebugInfo();
            
            if (user.id) {
                highlightSelectedUser(user.id);
            } else if (user.uid) {
                highlightSelectedUser(`clone_${user.id}`);
            }
            
            updateJSONEditor();
            
            addMapMarker(user, location, isCloneSimulation);
            
            document.getElementById('distanceDisplay').style.display = 'none';
            document.getElementById('timeSuggestion').innerHTML = '';
        }

        function addMapMarker(user, location, isCloneSimulation) {
            const locationData = systemData.locations.find(loc => loc.id === location);
            if (locationData) {
                const simulationType = isCloneSimulation ? ' (SIMULAÇÃO CLONE)' : '';
                const marker = L.marker(locationData.coords).addTo(map)
                    .bindPopup(`<b>${user.name || user.userName}${simulationType}</b><br>Uso em ${new Date().toLocaleTimeString()}<br>Local: ${locationData.name}`);
                
                setTimeout(() => {
                    map.removeLayer(marker);
                }, 10000);
            }
        }

        function showPinModal(user, location, isCloneSimulation) {
            document.getElementById('pinModal').classList.add('active');
            document.getElementById('pinError').style.display = 'none';
            currentPin = "";
            updatePinDisplay();
            
            const pinMessage = document.getElementById('pinMessage');
            if (isCloneSimulation) {
                pinMessage.textContent = "USO COM CARTAÃO CLONADO DETECTADO! Insira o PIN do cartão original:";
            } else {
                pinMessage.textContent = "Uso suspeito detectado! Distância impossível no tempo informado. Insira seu PIN:";
            }
            
            document.getElementById('pinModal').dataset.userId = user.id || user.uid;
            document.getElementById('pinModal').dataset.location = location;
            document.getElementById('pinModal').dataset.isClone = isCloneSimulation;
        }

        function verifyPin() {
            const userId = document.getElementById('pinModal').dataset.userId;
            const location = document.getElementById('pinModal').dataset.location;
            const isCloneSimulation = document.getElementById('pinModal').dataset.isClone === 'true';
            const locationData = systemData.locations.find(loc => loc.id === location);
            const locationName = locationData ? locationData.name : "Local Desconhecido";
            
            let originalUser;
            if (clonedCard) {
                originalUser = systemData.users.find(u => u.uid === clonedCard.originalUid);
            } else {
                originalUser = systemData.users.find(u => u.id == userId || u.uid === userId);
            }
            
            if (originalUser && currentPin === originalUser.pin) {
                document.getElementById('pinModal').classList.remove('active');
                document.getElementById('securityAlert').style.display = 'none';
                
                const simulationType = isCloneSimulation ? ' (SIMULAÇÃO CLONE)' : '';
                addLog(`✅ PIN verificado com sucesso para ${originalUser.name}${simulationType}.`, 'success');
                
                grantAccess(originalUser, location, locationName, isCloneSimulation);
            } else {
                document.getElementById('pinError').style.display = 'block';
                addLog(`❌ Falha na verificação de PIN.`, 'error');
                
                currentPin = "";
                updatePinDisplay();
            }
        }

        function cancelPin() {
            document.getElementById('pinModal').classList.remove('active');
            document.getElementById('securityAlert').style.display = 'none';
            addLog('Verificação de PIN cancelada. Acesso negado.', 'warning');
        }

        function cloneCard() {
            if (!selectedUser) {
                addLog('Selecione um usuário para clonar o cartão.', 'error');
                return;
            }
            
            const randomSuspect = suspiciousUsers[Math.floor(Math.random() * suspiciousUsers.length)];
            
            const clonedCardId = systemData.clonedCards.length + 1;
            const clonedCard = {
                id: clonedCardId,
                originalUid: selectedUser.uid,
                uid: selectedUser.uid + '_CLONE_' + clonedCardId,
                userName: randomSuspect,
                pin: selectedUser.pin,
                balance: selectedUser.balance,
                status: "active",
                lastUse: selectedUser.lastUse,
                lastLocation: selectedUser.lastLocation,
                cardType: selectedUser.cardType,
                failedPinAttempts: 0,
                usageHistory: selectedUser.usageHistory ? [...selectedUser.usageHistory] : []
            };
            
            systemData.clonedCards.push(clonedCard);
            
            addLog(`⚠️ Cartão de ${selectedUser.name} clonado. UID clonado: ${clonedCard.uid} usado por ${randomSuspect}`, 'warning');
            addLog(`📋 Clone permanente criado com mesmo PIN, saldo e histórico do original.`, 'success');
            
            renderUserList();
            updateUserSelect();
            updateStatistics();
            updateJSONEditor();
        }

        function resetCard() {
            if (!selectedUser && !clonedCard) {
                addLog('Selecione um usuário ou cartão clonado para resetar.', 'error');
                return;
            }
            
            const userToReset = clonedCard || selectedUser;
            
            userToReset.lastUse = null;
            userToReset.lastLocation = null;
            userToReset.usageHistory = [];
            
            addLog(`Histórico de uso resetado para ${userToReset.name || userToReset.userName}.`, 'success');
            renderUserList();
            updateJSONEditor();
            updateUsageHistory();
            updateDebugInfo();
            
            document.getElementById('distanceDisplay').style.display = 'none';
            document.getElementById('timeSuggestion').innerHTML = '';
        }

        function addBalance() {
            if (!selectedUser && !clonedCard) {
                addLog('Selecione um usuário ou cartão clonado para adicionar saldo.', 'error');
                return;
            }
            
            const userToAddBalance = clonedCard || selectedUser;
            
            userToAddBalance.balance += 20.00;
            
            if (clonedCard) {
                const originalUser = systemData.users.find(u => u.uid === clonedCard.originalUid);
                if (originalUser) {
                    originalUser.balance = userToAddBalance.balance;
                }
            }
            
            addLog(`Saldo de R$ 20,00 adicionado para ${userToAddBalance.name || userToAddBalance.userName}. Novo saldo: R$ ${userToAddBalance.balance.toFixed(2)}`, 'success');
            renderUserList();
            updateUserSelect();
            
            if (selectedUser) {
                highlightSelectedUser(selectedUser.id);
            } else if (clonedCard) {
                highlightSelectedUser(`clone_${clonedCard.id}`);
            }
            
            updateJSONEditor();
        }

        function refreshData() {
            addLog('Dados atualizados do servidor.', 'success');
            updateStatistics();
        }

        function clearLogs() {
            accessLogs = [];
            document.getElementById('accessLogs').innerHTML = 
                '<div class="log-entry"><span class="log-time">[' + 
                new Date().toLocaleTimeString() + 
                ']</span> <span class="log-success">Logs limpos. Sistema operacional.</span></div>';
            updateStatistics();
        }

        function updateJSONEditor() {
            document.getElementById('jsonData').value = JSON.stringify(systemData, null, 2);
        }

        function loadJSON() {
            try {
                const jsonText = document.getElementById('jsonData').value;
                const newData = JSON.parse(jsonText);
                
                if (!newData.users || !Array.isArray(newData.users)) {
                    throw new Error('Estrutura JSON inválida: campo "users" não encontrado ou não é um array');
                }
                
                if (!newData.locations || !Array.isArray(newData.locations)) {
                    throw new Error('Estrutura JSON inválida: campo "locations" não encontrado ou não é um array');
                }
                
                if (!newData.settings || typeof newData.settings !== 'object') {
                    throw new Error('Estrutura JSON inválida: campo "settings" não encontrado ou não é um objeto');
                }
                
                systemData = newData;
                initializeApp();
                addLog('Dados JSON carregados com sucesso.', 'success');
            } catch (error) {
                addLog(`Erro ao carregar JSON: ${error.message}`, 'error');
                alert(`Erro ao carregar JSON: ${error.message}`);
            }
        }

        function resetJSON() {
            systemData = JSON.parse(JSON.stringify(initialData));
            initializeApp();
            updateJSONEditor();
            addLog('Dados resetados para os valores iniciais.', 'success');
        }

        function exportJSON() {
            const dataStr = JSON.stringify(systemData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'sistema-catraca-rfid.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            addLog('Dados exportados para arquivo JSON.', 'success');
        }

        function renderUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            systemData.users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.dataset.userId = user.id;
                
                const lastUseInfo = user.lastUse ? 
                    `<div class="user-details">Último uso: ${user.lastLocation} (${new Date(user.lastUse).toLocaleTimeString()})</div>` : 
                    '<div class="user-details">Nenhum uso registrado</div>';
                
                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${user.name} <span class="status-indicator ${user.status === 'active' ? 'status-active' : 'status-blocked'}"></span></div>
                        <div class="user-details">UID: ${user.uid} | PIN: ${user.pin} | Tipo: ${getCardTypeName(user.cardType)}</div>
                        ${lastUseInfo}
                        <div class="user-actions">
                            <button class="action-btn btn-danger" onclick="deleteCard(${user.id}, 'user')"><i class="fas fa-trash"></i> Deletar</button>
                        </div>
                    </div>
                    <div class="user-balance">R$ ${user.balance.toFixed(2)}</div>
                `;

                userItem.addEventListener('click', function() {
                    selectedUser = user;
                    clonedCard = null;
                    document.getElementById('selectedUser').value = user.id;
                    highlightSelectedUser(user.id);
                    updateCloneInfo();
                    updateUsageHistory();
                    updateDebugInfo();
                });

                userList.appendChild(userItem);
            });

            systemData.clonedCards.forEach(clone => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.dataset.userId = `clone_${clone.id}`;
                userItem.style.backgroundColor = 'rgba(255, 204, 0, 0.1)';
                
                const lastUseInfo = clone.lastUse ? 
                    `<div class="user-details">Último uso: ${clone.lastLocation} (${new Date(clone.lastUse).toLocaleTimeString()})</div>` : 
                    '<div class="user-details">Nenhum uso registrado</div>';
                
                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${clone.userName} <span class="clone-badge">CLONE PERMANENTE</span> <span class="status-indicator ${clone.status === 'active' ? 'status-active' : 'status-blocked'}"></span></div>
                        <div class="user-details">UID: ${clone.uid} | PIN: ${clone.pin} | Original: ${clone.originalUid}</div>
                        ${lastUseInfo}
                        <div class="user-actions">
                            <button class="action-btn btn-danger" onclick="deleteCard(${clone.id}, 'clone')"><i class="fas fa-trash"></i> Deletar</button>
                        </div>
                    </div>
                    <div class="user-balance">R$ ${clone.balance.toFixed(2)}</div>
                `;

                userItem.addEventListener('click', function() {
                    clonedCard = clone;
                    selectedUser = null;
                    document.getElementById('selectedUser').value = `clone_${clone.id}`;
                    highlightSelectedUser(`clone_${clone.id}`);
                    updateCloneInfo();
                    updateUsageHistory();
                    updateDebugInfo();
                });

                userList.appendChild(userItem);
            });
        }

        function deleteCard(id, type) {
            if (type === 'user') {
                const userIndex = systemData.users.findIndex(u => u.id === id);
                if (userIndex !== -1) {
                    const userName = systemData.users[userIndex].name;
                    systemData.users.splice(userIndex, 1);
                    addLog(`Usuário ${userName} deletado do sistema.`, 'success');
                }
            } else if (type === 'clone') {
                const cloneIndex = systemData.clonedCards.findIndex(c => c.id === id);
                if (cloneIndex !== -1) {
                    const cloneUid = systemData.clonedCards[cloneIndex].uid;
                    systemData.clonedCards.splice(cloneIndex, 1);
                    addLog(`Cartão clonado ${cloneUid} deletado do sistema.`, 'success');
                }
            }
            
            selectedUser = null;
            clonedCard = null;
            document.getElementById('selectedUser').value = '';
            
            renderUserList();
            updateUserSelect();
            updateStatistics();
            updateCloneInfo();
            updateUsageHistory();
            updateDebugInfo();
            updateJSONEditor();
        }

        function getCardTypeName(cardType) {
            const types = {
                'normal': 'Normal',
                'student': 'Estudante',
                'elderly': 'Idoso'
            };
            return types[cardType] || cardType;
        }

        function highlightSelectedUser(userId) {
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });

            const selectedItem = document.querySelector(`.user-item[data-user-id="${userId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
        }

        function updateUserSelect() {
            const userSelect = document.getElementById('selectedUser');
            userSelect.innerHTML = '<option value="">Selecione um usuário</option>';
            
            systemData.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.uid})`;
                userSelect.appendChild(option);
            });
            
            systemData.clonedCards.forEach(clone => {
                const option = document.createElement('option');
                option.value = `clone_${clone.id}`;
                option.textContent = `${clone.userName} (${clone.uid} [CLONE])`;
                userSelect.appendChild(option);
            });
        }

        function updatePointsGrid() {
            const pointsGrid = document.getElementById('pointsGrid');
            pointsGrid.innerHTML = '';
            
            systemData.locations.forEach(location => {
                const pointBtn = document.createElement('button');
                pointBtn.className = 'point-btn';
                pointBtn.textContent = location.name;
                pointBtn.dataset.locationId = location.id;
                
                pointBtn.addEventListener('click', function() {
                    document.querySelectorAll('.point-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    selectedPoint = location.id;
                    
                    calculateAndDisplayDistance();
                });
                
                pointsGrid.appendChild(pointBtn);
            });
        }

        function updateStatistics() {
            document.getElementById('totalUsers').textContent = systemData.users.length;
            document.getElementById('tripsToday').textContent = accessLogs.filter(log => 
                log.type === 'access_granted' && isToday(log.timestamp)
            ).length;
            document.getElementById('securityAlerts').textContent = accessLogs.filter(log => 
                log.type === 'security_alert'
            ).length;
            document.getElementById('blockedCards').textContent = systemData.users.filter(user => 
                user.status === 'blocked'
            ).length + systemData.clonedCards.filter(clone => clone.status === 'blocked').length;
            document.getElementById('cloneSimulations').textContent = systemData.systemStats.cloneSimulations || 0;
        }

        function updateCloneInfo() {
            const cloneInfo = document.getElementById('cloneInfo');
            
            if (simulationMode === 'clone') {
                cloneInfo.style.display = 'block';
            } else {
                cloneInfo.style.display = 'none';
            }
        }

        function isToday(timestamp) {
            if (!timestamp) return false;
            const today = new Date().toDateString();
            const logDate = new Date(timestamp).toDateString();
            return today === logDate;
        }

        function addLog(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let typeClass = 'log-success';
            if (type === 'error') typeClass = 'log-error';
            if (type === 'warning') typeClass = 'log-warning';
            
            logEntry.innerHTML = `
                <span class="log-time">[${timestamp}]</span> 
                <span class="${typeClass}">${message}</span>
            `;
            
            document.getElementById('accessLogs').prepend(logEntry);
            
            const logsContainer = document.getElementById('accessLogs');
            if (logsContainer.children.length > 50) {
                logsContainer.removeChild(logsContainer.lastChild);
            }
            
            accessLogs.unshift({
                timestamp: new Date(),
                message: message,
                type: type
            });
            
            updateStatistics();
        }
    </script>
</body>
</html>
